<p-toast />
<div
  [ngClass]="{ 'bg-[#374151]': !frame.backgroundColor }"
  [style.background-color]="frame.backgroundColor"
  [ngStyle]="
    frame.backgroundUrl
      ? { 'background-image': 'url(' + frame.backgroundUrl + ')' }
      : {}
  "
  class="bg-[#374151] rounded-2xl w-[98vw] md:w-[97vw] h-[89vh] md:h-[87vh] m-2 md:m-5 frame overflow-x-auto"
>
  <div
    class="bg-white/20 w-full rounded-t-xl p-2 md:p-3 justify-between flex flex-wrap items-center gap-2"
  >
    <h1
      *ngIf="!isEditingTitle"
      (click)="startEditTitle()"
      [ngClass]="[editable ? '' : 'cursor-default']"
      class="hover:bg-white/10 transition-colors cursor-text text-black/70 text-xl p-1 rounded-lg font-bold truncate"
    >
      {{ frame.name }}
    </h1>
    <input
      *ngIf="isEditingTitle"
      id="frame-title-input"
      type="text"
      [(ngModel)]="tempTitle"
      (keydown.enter)="saveTitle()"
      (keydown.escape)="cancelEditTitle()"
      (blur)="saveTitle()"
      [attr.size]="(tempTitle.length || frame.name.length || 1) + 1"
      class="text-black/80 text-xl p-1 rounded-lg font-bold focus:bg-white/60 outline-none w-auto inline-block"
    />

    <div class="items-center flex gap-1 md:gap-2 flex-wrap">
      @for (item of collaborators; track $index) {
      <p-avatar
        (click)="openCollaboratorPanel($event, item, op)"
        [label]="getInitial(item)"
        styleClass="cursor-pointer"
        matTooltip="Perfil"
        [style]="{ 'background-color': '#dee9fc', color: '#1a2551' }"
        shape="circle"
      />
      }
      <button
        (click)="op2.toggle($event)"
        class="group text-white hover:bg-white/10 transition-colors p-2 rounded-full"
        matTooltip="Visibilidade"
      >
        <lucide-angular
          [img]="usersRound"
          color="black"
          size="22"
        ></lucide-angular>
      </button>
      <button
        (click)="visible = true"
        class="group flex items-center gap-1 text-black hover:bg-white/90 bg-white/80 transition-colors p-2 rounded-lg"
        matTooltip="Compartilhar"
      >
        <lucide-angular
          [img]="userRoundPlus"
          color="black"
          size="18"
        ></lucide-angular>
        <span class="hidden sm:inline">compartilhar</span>
      </button>
      <button
        (click)="menu.toggle($event)"
        class="group text-white hover:bg-white/10 transition-colors p-2 rounded-full"
        matTooltip="Configurações"
      >
        <lucide-angular
          [img]="ellipsis"
          color="black"
          size="22"
        ></lucide-angular>
      </button>
      <p-menu #menu [model]="items" [popup]="true" />
    </div>
  </div>
  <div
    class="flex gap-3 md:gap-4 p-2 md:p-2 m-1 md:m-2 overflow-x-auto max-w-[96vw] md:max-w-[95vw] h-[80vh] md:h-[76vh]"
    cdkDropList
    cdkDropListOrientation="horizontal"
    [cdkDropListData]="frame.lists || []"
    (cdkDropListDropped)="dropListReorder($event)"
  >
    @for (tasklist of frame.lists; track $index) {
    <div class="snap-start" cdkDrag [cdkDragData]="tasklist">
      <app-task-list
        [taskList]="tasklist"
        [connectedDropLists]="dropListIds"
      ></app-task-list>
    </div>
    }
    <div class="snap-start">
      <app-task-list-default [workspaceId]="frame.id"></app-task-list-default>
    </div>
  </div>
</div>

<p-overlayPanel #op2 [showCloseIcon]="true" [style]="{ width: '300px' }">
  <div class="w-48">
    <p>Alterar Visibilidade</p>
  </div>
  <div class="py-2 gap-2 flex flex-col">
    <div
      (click)="changeVisibility(true)"
      [ngClass]="frame.visibility === true ? 'bg-gray-800' : ''"
      class="p-2 cursor-pointer hover:bg-gray-800 rounded-lg transition-colors"
    >
      <div class="flex flex-col gap-1">
        <div class="flex gap-1 items-center">
          <lucide-angular
            [img]="earth"
            color="green"
            size="18"
          ></lucide-angular>
          <span> Público</span>
        </div>
        <div class="text-sm text-gray-500">
          Qualquer pessoa na internet pode ver este quadro. Apenas membros
          adicionados podem fazer alterações.
        </div>
      </div>
    </div>
    <div
      (click)="changeVisibility(false)"
      [ngClass]="frame.visibility === false ? 'bg-gray-800' : ''"
      class="p-2 cursor-pointer hover:bg-gray-800 rounded-lg transition-colors"
    >
      <div class="flex flex-col gap-1">
        <div class="flex gap-1 items-center">
          <lucide-angular
            [img]="lockKeyhole"
            color="red"
            size="18"
          ></lucide-angular>
          <span> Privado</span>
        </div>
        <div class="text-sm text-gray-500">
          Apenas membros adicionados podem ver e fazer alterações neste quadro.
        </div>
      </div>
    </div>
  </div>
</p-overlayPanel>

<p-overlayPanel #op>
  <div class="p-2 w-56">
    <div class="flex items-center gap-3">
      <p-avatar
        [label]="getInitial(selectedCollaborator || null)"
        styleClass="mr-2"
        [style]="{ 'background-color': '#dee9fc', color: '#1a2551' }"
        shape="circle"
      />
      <div class="flex flex-col">
        <span class="text-sm font-semibold">{{
          selectedCollaborator?.name || "Colaborador"
        }}</span>
        <span class="text-xs text-gray-400">{{
          selectedCollaborator?.email || ""
        }}</span>
        <div *ngIf="selectedCollaborator?.id === frame.ownerId">
          <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full"
            >Proprietário</span
          >
        </div>
        <div *ngIf="selectedCollaborator?.id !== frame.ownerId && isOwner">
          <button
            (click)="removeCollaborator(selectedCollaborator!)"
            class="text-xs text-red-600 hover:underline mt-1"
          >
            Remover do quadro
          </button>
        </div>
        <div
          *ngIf="selectedCollaborator?.id !== frame.ownerId && !isOwner"
          class="text-xs text-gray-400 mt-1"
        >
          Apenas o proprietário pode remover colaboradores
        </div>
      </div>
    </div>
  </div>
</p-overlayPanel>

<p-dialog
  header="Compartilhar quadro"
  [modal]="true"
  [(visible)]="visible"
  [style]="{ width: '90vw', maxWidth: '400px' }"
>
  <ng-template pTemplate="content">
    <div class="flex flex-col gap-3">
      <label for="email" class="text-white/80"
        >Adicionar pessoas ao quadro</label
      >
      <input
        id="email"
        type="email"
        id="email"
        placeholder="Digite o email"
        class="p-2 rounded-lg bg-transparent border border-gray-700 text-white w-full placeholder:!text-white/40 focus:outline-none"
      />
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <button mat-flat-button color="warn" class="mr-2" (click)="visible = false">
      Fechar
    </button>
    <button (click)="sendInvite()" mat-flat-button color="primary">
      Adicionar
    </button>
  </ng-template>
</p-dialog>

<app-dialog
  [(visible)]="display"
  [header]="'Editar quadro'"
  [isCreating]="isCreating"
  (create)="handleCreate($event)"
  [submitLabel]="'Salvar'"
  [initialData]="frame"
></app-dialog>
